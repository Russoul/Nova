//Let's take a look at setoids inside extensional MLTT

((x y : A) âŠ¦ x ~ y : ğ•Œ) âŠ¦ Equiv(~) â‰” ((x : A) âŠ¦ Refl(x) : x ~ x)
                                   â¨¯ ((p : x ~ y) âŠ¦ pâ»Â¹ : y ~ x)
                                   â¨¯ (((p : x ~ y) (q : y ~ z) âŠ¦ p âˆ™ q : x ~ z)): ğ•Œ


//We'll use (~) for equivalence relations going forth

//Setoid is a pair: (A, ~)

//Setoid homomorphism (A, ~) â‡’ (B, ~)
//is
(f : A â†’ B) â¨¯ ((x ~ y) â†’ (f x ~ f y))

//Take the usual definition of natural numbers
//Take the usual observational equality relation on them
//Together they form a setoid (â„•, ~)


Given
(A, ~) : Setoid
(B, ~) : Setoid
---------------
We can form a new equivalence relation:
~ : (A â¨¯ B) â†’ (A â¨¯ B) â†’ ğ•Œ
(aâ‚€, bâ‚€) ~ (aâ‚, bâ‚) â‰” (aâ‚€ ~ aâ‚) â¨¯ (bâ‚€ ~ bâ‚)
hence
(A â¨¯ B, ~) : Setoid

Given
(A, ~) : Setoid
(B, ~) : Setoid
---------------
We can form a new equivalence relation:
(~) : (A â†’ B) â†’ (A â†’ B) â†’ ğ•Œ
f ~ g â‰” {aâ‚€ aâ‚} (aâ‚€ ~ aâ‚) â†’ (f aâ‚€ ~ f aâ‚)
hence
(A â†’ B, ~) : Setoid

(A, ~) : Setoid
--------------
Contr(A) â‰” (c : A) â¨¯ ((x : A) â†’ x ~ c)

f : (A, ~) â‡’ (B, ~)
b : B
---------------------------------
Fibre(f, b) â‰” (x : A) â¨¯ (f x ~ b)

//We can define
(~) : ((A, ~) â‡’ (B, ~)) â†’ ((A, ~) â‡’ (B, ~)) â†’ ğ•Œ
(f, Î±) ~ (g, Î²) â‰” (f ~ g)


                       H x
   x          f x  - - - - - - - g x
   |           |                  |
   | p         | f p              | g p
   |           |                  |
   y          f y  - - - - - - - g y

Eâ‚€ : â„¤ â‰ƒ â„¤
Eâ‚ : â„¤ â‰ƒ â„¤

Eâ‚€ = Eâ‚

                       (+3)
   â„•           â„¤ - - - - - - - -  â„¤
   |           |                  |
   | p         | (+2)             | (+1)
   |           |                  |
   â„•           â„¤  - - - - - - - - â„¤
                       (+4)

(+1) âˆ˜ (+2) ~ (+3)
but
(+1) âˆ˜ (+2) â‰ (+4)

This example shows us that if one has proof-relevant equivalence relation then
one also needs proof-relevant equivalence relelation on that relation.

//Hence
//((A, ~) â‡’ (B, ~), ~) : Setoid

f : (A, ~) â‡’ (B, ~)
-----------------------------------------------
l-inv(f) â‰” (g : (B, ~) â‡’ (A, ~)) â¨¯ (g âˆ˜ f) ~ id

f : (A, ~) â‡’ (B, ~)
-------------------
r-inv(f) â‰” (g : (B, ~) â‡’ (A, ~)) â¨¯ (f âˆ˜ g) ~ id

//We can define
~ : Setoid â†’ Setoid â†’ ğ•Œ
(A, ~) ~ (B, ~) â‰” (f : (A, ~) â‡’ (B, ~)) â¨¯ l-inv(f) â¨¯ r-inv(g)

//Hence
(Setoid, ~) : Setoid

//Notation:
(f, Î±) : (A, ~) â‡’ (B, ~)
a : A
------------------------
(f, Î±) a â‰” f a : B

//Notation:
(f, Î±) : (A, ~) â‡’ (B, ~)
p : aâ‚€ ~ aâ‚
----------------------------
(f, Î±) p â‰” Î± p : f aâ‚€ ~ f aâ‚


//Notation:
A B : Setoid
P : A ~ B
a : A
------------------
(f, Î±) a = f a : B

//Notation:
(A, ~) : Setoid
--------------- (implicit coercion)
(A, ~) = A : ğ•Œ

B : (A, ~) â‡’ Setoid
aâ‚€ aâ‚ : A
a : aâ‚€ ~ aâ‚
---------------------------------
EquivOver(A, a) : B aâ‚€ â†’ B aâ‚ â†’ ğ•Œ
EquivOver(A, a) bâ‚€ bâ‚ â‰” B a bâ‚€ ~ bâ‚

//Given
(A, ~) : Setoid
B : (A, ~) â‡’ Setoid
//We can form a new equivalence relation:
~ : ((x : A) â¨¯ B x) â†’ ((x : A) â¨¯ B x) â†’ ğ•Œ
(aâ‚€, bâ‚€ : B aâ‚€) ~ (aâ‚, bâ‚ : B aâ‚) â‰” (a : aâ‚€ ~ aâ‚) â¨¯ EquivOver(A, a) bâ‚€ bâ‚
//Hence
(((x : A) â¨¯ B x), ~) : Setoid

//Given
B : (A, ~) â‡’ Setoid
//We can form a new equivalence relation:
~ : ((x : A) â†’ B x) â†’ ((x : A) â†’ B x) â†’ ğ•Œ
f ~ g â‰” âˆ€ {aâ‚€ aâ‚ : A} (a : aâ‚€ ~ aâ‚) â†’ EquivOver(A, a) (f aâ‚€) (f aâ‚)
//Hence
(((x : A) â†’ B x), ~) : Setoid


(~) : List A â†’ List A â†’ ğ•Œ
[] ~ [] â‰” ğŸ™
[] ~ (_ :: _) â‰” ğŸ˜
(_ :: _) ~ [] â‰” ğŸ˜
(a :: as) ~ (b :: bs) â‰” (a ~ b) â¨¯ (as ~ bs)

//Can we show that List : ğ•Œ â†’ ğ•Œ
//is a setoid homomorphism?
//It's enough to show that
A B : ğ•Œ
Î± : A â‰ƒ B â†’ List A â‰ƒ List B
//So it's enough to show:
A B : ğ•Œ
E : A â‰ƒ B
----------------------
Î±.Ï€â‚ : A â‰ƒ B â†’ (List A â‡’ List B)


Î±.Ï€â‚.U : List A â†’ List B
Î±.Ï€â‚.U [] = []
Î±.Ï€â‚.U (x :: xs) = E x :: Î±.U xs

Î±.Ï€â‚.cong : {xs ys : List A} (xs ~ ys) â†’ Î±.U xs ~ Î±.U ys
Î±.Ï€â‚.cong {[]} {[]} () = ()
Î±.Ï€â‚.cong {[]} {_ :: _} contra = absurd contra
Î±.Ï€â‚.cong {_ :: _} {[]} contra = absurd contra
Î±.Ï€â‚.cong {aâ‚€ :: asâ‚€} {aâ‚ :: asâ‚} (a : aâ‚€ ~ aâ‚, as : asâ‚€ ~ asâ‚) = (E a, Î±.cong as) : (E aâ‚€ :: Î±.U asâ‚€) ~ (E aâ‚ :: Î±.U asâ‚)
                                                                                     =
                                                                                     (E aâ‚€ ~ Eâ‚ aâ‚) â¨¯ (Î±.U asâ‚€ ~ Î±.U asâ‚)

//now we need to show
Î² : A â‰ƒ B â†’ (List B â‡’ List A)

...

Hence It's quite easy to show that List is a setoid homomorphism


(A â¨¯ B) ~ (B â¨¯ A)

swap (a, b) = (b, a)

swap (p : aâ‚€ ~ aâ‚, q : bâ‚€ ~ bâ‚) = (q, p) : (bâ‚€ ~ bâ‚) â¨¯ (aâ‚ ~ aâ‚€)

swap âˆ˜ swap ~ id

(a, b) : A â¨¯ B

Refl : (a, b) ~ (a, b)
